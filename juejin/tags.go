package juejin

import (
	"context"
	"time"

	"github.com/go-rod/rod"
	"github.com/go-rod/rod/lib/input"
)

var (
	TAG_INPUT = `//*[@id="juejin-web-editor"]/div[2]/div/header/div[2]/div[3]/div/div[3]/div[2]/div/div/div/div[1]/input`
	TAG_ITEMS = `/html/body/div[6]/div/li[1]`
)

var AllowedTags = []string{
	"前端",
	"后端",
	"JavaScript",
	"面试",
	"Vue.js",
	"GitHub",
	"Java",
	"架构",
	"算法",
	"CSS",
	"代码规范",
	"数据库",
	"Node.js",
	"程序员",
	"前端框架",
	"设计模式",
	"React.js",
	"HTML",
	"Linux",
	"Android",
	"人工智能",
	"Python",
	"微信小程序",
	"MySQL",
	"Git",
	"开源",
	"Webpack",
	"设计",
	"HTTP",
	"Redis",
	"产品",
	"iOS",
	"全栈",
	"ECMAScript 6",
	"Docker",
	"Nginx",
	"机器学习",
	"微信",
	"正则表达式",
	"Google",
	"Spring",
	"Chrome",
	"黑客",
	"jQuery",
	"响应式设计",
	"编程语言",
	"Go",
	"APP",
	"TypeScript",
	"React Native",
	"Android Studio",
	"命令行",
	"创业",
	"深度学习",
	"Angular.js",
	"数据可视化",
	"产品经理",
	"Mac",
	"Spring Boot",
	"操作系统",
	"Vuex",
	"Bootstrap",
	"Apple",
	"微服务",
	"PHP",
	"安全",
	"API",
	"Photoshop",
	"运维",
	"MongoDB",
	"图片资源",
	"阿里巴巴",
	"数据挖掘",
	"Canvas",
	"源码",
	"C++",
	"Visual Studio Code",
	"Sublime Text",
	"爬虫",
	"设计师",
	"gradle",
	"Swift",
	"招聘",
	"MVVM",
	"Material Design",
	"云计算",
	"Flutter",
	"性能优化",
	"敏捷开发",
	"NPM",
	"JVM",
	"Markdown",
	"数据分析",
	"Xcode",
	"物联网",
	"RxJava",
	"Vite",
	"动效",
	"HTTPS",
	"数据结构",
	"腾讯",
	"浏览器",
	"Objective-C",
	"SQL",
	"字体",
	"MyBatis",
	"测试",
	"运营",
	"JSON",
	"Ajax",
	"Icon",
	"分布式",
	"Spring Cloud",
	"LeetCode",
	"大数据",
	"Kotlin",
	"虚拟现实",
	"Redux",
	"DOM",
	"电子书",
	"Debug",
	"Elasticsearch",
	"Ubuntu",
	"负载均衡",
	"掘金翻译计划",
	"Eclipse",
	"Kubernetes",
	"Promise",
	"maven",
	"uni-app",
	"SCSS",
	"vue-router",
	"配色",
	"游戏",
	"Sketch",
	"Kafka",
	"IntelliJ IDEA",
	"C",
	"SVG",
	"Element",
	"ECharts",
	"函数式编程",
	"区块链",
	"VIM",
	"Apache",
	"Windows",
	"计算机视觉",
	"神经网络",
	"three.js",
	"Facebook",
	"axios",
	"Java EE",
	"TensorFlow",
	"支付宝",
	"稀土",
	"WebGL",
	"SEO",
	"网络协议",
	"Unity3D",
	"TCP/IP",
	"ChatGPT",
	"Express",
	"单元测试",
	"响应式编程",
	"Microsoft",
	"增强现实",
	"Electron",
	"Hadoop",
	"Gulp",
	"WebSocket",
	"服务器",
	"SQLite",
	"嵌入式",
	"远程工作",
	"Tomcat",
	"云原生",
	"求职",
	"Firefox",
	"机器人",
	"RocketMQ",
	"RabbitMQ",
	"APK",
	"Django",
	"容器",
	"NoSQL",
	"投资",
	"Webkit",
	"编译器",
	"比特币",
	"OpenAI",
	"消息队列",
	"MVC",
	"Atom",
	"Shell",
	"百度",
	"Dubbo",
	"AIGC",
	"科幻",
	"ZooKeeper",
	"Rust",
	"flexbox",
	"连续集成",
	"Netty",
	"CentOS",
	".NET",
	"Spark",
	"GitLab",
	"V2EX",
	"d3.js",
	"NLP",
	"Postman",
	"掘金日报",
	"Less",
	"PostgreSQL",
	"UI Kit",
	"Safari",
	"交互设计",
	"音视频开发",
	"Laravel",
	"Twitter",
	"LLM",
	"ORM",
	"SSH",
	"Weex",
	"Wireshark",
	"HarmonyOS",
	"Jenkins",
	"AI编程",
	"C#",
	"ESLint",
	"Ruby",
	"macOS",
	"UML",
	"Sea.js",
	"JetBrains",
	"Babel",
	"如何当个好爸爸",
	"ionic",
	"koa",
	"源码阅读",
	"状态机",
	"搜索引擎",
	"Grunt",
	"线下活动",
	"直播",
	"Oracle",
	"掘金技术征文",
	"SVN",
	"Flask",
	"增长黑客",
	"Hacker News",
	"Ant Design",
	"PostCSS",
	"CDN",
	"DNS",
	"Android Jetpack",
	"小程序·云开发",
	"Scala",
	"笔记",
	"Backbone.js",
	"沸点",
	"Lua",
	"Flux",
	"视觉设计",
	"游戏开发",
	"MVP",
	"Retrofit",
	"前端工程化",
	"树莓派",
	"OKHttp",
	"PyCharm",
	"逆向",
	"CMS",
	"GraphQL",
	"自动化运维",
	"掘金·日新计划",
	"ECMAScript 8",
	"资讯",
	"Yarn",
	"年终总结",
	"DeepSeek",
	"Medium",
	"PyTorch",
	"ReactiveX",
	"排序算法",
	"V8",
	"Apple Watch",
	"Underscore.js",
	"WebAssembly",
	"Web Components",
	"DNodeJS",
	"午夜话题",
	"OpenCV",
	"低代码",
	"Cocoa",
	"Instagram",
	"Meteor.js",
	"WebRTC",
	"Flink",
	"Excel",
	"图像识别",
	"Dart",
	"汇编语言",
	"GPT",
	"Keynote",
	"掘金·金石计划",
	"Android Wear",
	"强化学习",
	"Nuxt.js",
	"Uber",
	"SaaS",
	"掘金社区",
	"RxJS",
	"CoffeeScript",
	"iView",
	"七牛云",
	"ThinkPHP",
	"Swagger",
	"监控",
	"Ember.js",
	"Bower",
	"WebP",
	"NestJS",
	"AB测试",
	"LLVM",
	"Zepto.js",
	"Egg.js",
	"HBase",
	"XSS",
	"蓝牙",
	"团队管理",
	"IPython",
	"mpvue",
	"JUnit",
	"fir.im",
	"RequireJS",
	"OpenGL",
	"SwiftUI",
	"PhpStorm",
	"WeUI",
	"WWDC",
	"Chart.js",
	"Shiro",
	"计算机图形学",
	"Rails",
	"ReactiveCocoa",
	"Surge",
	"自动驾驶",
	"SAMSUNG",
	"以太坊",
	"Trae",
	"Trello",
	"RxSwift",
	"数学",
	"LaTex",
	"图形学",
	"CTO",
	"MCP",
	"Hibernate",
	"Travis CI",
	"FFmpeg",
	"编译原理",
	"DaoCloud",
	"PWA",
	"PyQt",
	"Slack",
	"VirtualBox",
	"EventBus",
	"gRPC",
	"Apache Hive",
	"Hexo",
	"Solr",
	"Cursor",
	"Arduino",
	"iTerm",
	"Y Combinator",
	"领域驱动设计",
	"Agent",
	"NumPy",
	"Glide",
	"Amazon",
	"Apache ActiveMQ",
	"MariaDB",
	"WordPress",
	"MATLAB",
	"Memcached",
	"Core ML",
	"HDFS",
	"C语言",
	"ARKit",
	"莆田",
	"Dagger",
	"JMeter",
	"Workflow",
	"Vonic",
	"360",
	"Gson",
	"Serverless",
	"Fiddler",
	"Scrapy",
	"数字货币",
	"RESTful",
	"Polymer",
	"Next.js",
	"web3",
	"播客",
	"pandas",
	"客户端",
	"王者荣耀",
	"Cocos2d-x",
	"Curl",
	"CircleCI",
	"5G",
	"OpenStack",
	"Cython",
	"Axure",
	"Taro",
	"Fastjson",
	"Pixate",
	"CI/CD",
	"华为",
	"HTTP3",
	"Qt",
	"PhantomJS",
	"Charles",
	"Apache Log4j",
	"Selenium",
	"HotFix",
	"Elm",
	"Google IO",
	"Picasso",
	"Emacs",
	"Unicode",
	"Yii",
	"Lucene",
	"AWS",
	"Kibana",
	"智能合约",
	"Apache Storm",
	"PM2",
	"protobuf",
	"DevOps",
	"Cordova",
	"Realm",
	"Vant",
	"bpython",
	"NVIDIA",
	"Tornado",
	"快应用",
	"Groovy",
	"R",
	"MobX",
	"智能小程序",
	"etcd",
	"Claude",
	"Linkedin",
	"Swoole",
	"RSS",
	"Logstash",
	"rollup.js",
	"Touch bar",
	"Firebase",
	"边缘计算",
	"web.py",
	"DBA",
	"Coze",
	"LangChain",
	"Grafana",
	"VuePress",
	"TiDB",
	"AndroidAnnotations",
	"KVM",
	"青训营笔记",
	"量子计算",
	"GIS",
	"Debian",
	"Highlight.js",
	"GPU",
	"scikit-learn",
	"Airbnb",
	"PyPy",
	"Kaggle",
	"NativeScript",
	"greenDAO",
	"Stylus",
	"RPC",
	"Apache Flume",
	"ZeroMQ",
	"FreeMarker",
	"计算机组成原理",
	"Elixir",
	"Composer",
	"Ansible",
	"Keras",
	"Apache Thrift",
	"Jest",
	"Volley",
	"Caffe",
	"SciPy",
	"CocoaPods",
	"Immutable.js",
	"Akka",
	"Unreal Engine",
	"ButterKnife",
	"ZXing",
	"Project Lombok",
	"Apache Kylin",
	"Mocha",
	"WebView",
	"Erlang",
	"JCenter",
	"Karma",
	"AFNetworking",
	"VisualVM",
	"Perl",
	"Vagrant",
	"WebVR",
	"Apache Cassandra",
	"LeakCanary",
	"PhoneGap",
	"WebStorm",
	"JSPatch",
	"Apache Mesos",
	"Tinker",
	"deno",
	"Yeoman",
	"Swarm",
	"无人机",
	"Lisp",
	"掘金圆桌",
	"SDWebImage",
	"有赞",
	"Preact",
	"Haskell",
	"LevelDB",
	"Daydream",
	"pyspider",
	"Fresco",
	"Service Mesh",
	"豆包MarsCode",
	"Apache Ant",
	"Fedora",
	"SonarQube",
	"Gevent",
	"SymPy",
	"Bluebird.js",
	"Raft",
	"芯片",
	"Browserify",
	"Gunicorn",
	"Clojure",
	"uWSGI",
	"MPAndroidChart",
	"Jieba",
	"Istio",
	"Xposed",
	"Snapchat",
	"E2E",
	"AMP",
	"Android Things",
	"Omi",
	"NSQ",
	"Mockito",
	"视频编码",
	"Twisted",
	"Brython",
	"Bintray",
	"Fluentd",
	"Puppeteer",
	"Symfony",
	"Jekyll",
	"Unix",
	"CasperJS",
	"Agera",
	"Gin",
	"IndexedDB",
	"reCAPTCHA",
	"DeepStack",
	"QUnit",
	"Natural Language Toolkit",
	"Jupyter",
	"ORMLite",
	"FMDB",
	"Jasmine",
	"ThinkJS",
	"Alamofire",
	"Gemini",
	"ReactOS",
	"MJRefresh",
	"SaltStack",
	"Traefik",
	"AsyncDisplayKit",
	"marked",
	"Fuchsia",
	"fastlane",
	"AIOps",
	"Mongoose",
	"Monolog",
	"Chrome OS",
	"SnapKit",
	"IGListKit",
	"Perfect",
	"Bulma",
	"Solidity",
	"Caddy",
	"Anko",
	"Julia",
	"Parcel",
	"Knockout",
	"AChartEngine",
	"StatsD",
	"Theano",
	"Vapor",
	"ARCore",
	"libGDX",
	"Polycode",
	"Feathers",
	"mlpack",
	"DroidMVP",
	"Espresso",
	"Phabricator",
	"JitPack",
	"Carthage",
	"Classyshark",
	"Vuforia",
	"AVA",
	"Svelte",
	"RoboSpice",
	"推广",
	"Stetho",
	"FlatBuffers",
	"GAN",
	"MessagePack",
	"Buck",
	"Marko",
	"Libratus",
	"EazeGraph",
	"DbInspector",
	"RoboGuic",
	"Fossil",
	"Microsoft Edge",
	"ArkTS",
	"HTM",
	"PyCon",
	"cesium",
	"Sora",
	"RTC",
	"Mozilla",
	"Smartisan OS",
	"FoundationDB",
	"CMake",
	"iPadOS",
	"文心一言",
	"mPaaS",
	"NuGet",
	"笔记测评",
	"Midjourney",
	"Godot",
	"京东小程序",
	"NEO",
	"AMA",
	"LLaMA",
	"GWT",
	"Chameleon",
	"Ollama",
	"通义灵码",
	"tvOS",
	"单片机",
	"Ramda",
	"Libra",
	"TLA+",
	"ArkUI",
	"百度飞桨",
	"D",
	"Debezium",
	"Cocos Creator",
	"greenplum",
	"SQL Server",
	"Visual Studio",
	"stable diffusion",
	"FastAPI",
	"visionOS",
	"VibeCoding",
	"Cline",
	"arco design",
	"VitePress",
	"抖音小程序",
	"Modern.js",
	"Grok",
	"DALL-E3",
	"轻服务",
	"工作流引擎",
	"Semi Design",
	"Turbopack",
	"Fes.js",
	"cpu",
	"Bun",
	"Github Copilot",
	"ChatGLM (智谱)",
	"w3cplus",
	"bpmn-js",
	"Zabbix",
	"mistral.ai",
	"Phaser",
	"Solo",
	"kerberos",
	"ArkWeb",
	"CodeBuddy",
	"meta",
	"ArkData",
	"Visual Studio IntelliCode",
	"WindSurf",
	"Devin",
	"文心快码",
	"bolt",
	"V0",
	"CodeFuse",
	"CodeWhisperer",
	"replit",
	"Yi",
	"Tabnine",
	"imgcook",
	"Warp",
	"FittenCode",
	"Lovable",
}

// validateTags 验证并过滤标签，只返回允许的标签，最多3个
func validateTags(tags []string) []string {
	if len(tags) == 0 {
		return nil
	}

	// 创建允许标签的 map 以便快速查找
	allowedMap := make(map[string]bool)
	for _, tag := range AllowedTags {
		allowedMap[tag] = true
	}

	// 过滤标签：只保留在允许列表中的标签，最多3个
	var validTags []string
	for _, tag := range tags {
		if allowedMap[tag] {
			validTags = append(validTags, tag)
			// 如果已经有3个合规标签，忽略后面的
			if len(validTags) >= 3 {
				break
			}
		}
	}

	return validTags
}

func SelectTags(page *rod.Page, _ctx context.Context, tags []string) error {
	// 验证并过滤标签，只保留允许的标签，最多3个
	validTags := validateTags(tags)
	if len(validTags) == 0 {
		return nil
	}

	tagInput := page.MustElementX(TAG_INPUT)
	tagInput.MustInput(validTags[0])

	time.Sleep(2 * time.Second)

	tagInput.MustType(input.Enter)

	return nil
}
